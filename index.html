<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Permanent Cloud AR Editor</title>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    
    <style>
        :root { --blue: #007aff; --bg: #050505; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; margin: 0; }
        .admin-panel { max-width: 500px; margin: 40px auto; padding: 30px; background: #111; border-radius: 20px; border: 1px solid #333; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; background: #222; border: 1px solid #444; color: white; border-radius: 8px; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; background: var(--blue); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        #output-section { display: none; margin-top: 20px; padding: 15px; background: #000; border: 1px dashed var(--blue); border-radius: 12px; }
        
        /* Model Viewer Style */
        #viewer-container { display: none; width: 100%; height: 100vh; position: fixed; inset: 0; background: #000; z-index: 1000; }
        .back-btn { position: absolute; top: 20px; left: 20px; z-index: 1001; background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 20px; border-radius: 20px; }
    </style>
</head>
<body>

<div id="setup-ui">
    <div class="admin-panel">
        <h2 style="color:var(--blue); margin-top:0;">Permanent AR Publisher</h2>
        <p style="font-size: 13px; opacity: 0.6;">এটি অটোমেটিক ক্লাউড সার্ভারে সেভ করে রাখবে।</p>
        
        <label>প্রজেক্টের নাম:</label>
        <input type="text" id="p-title" placeholder="যেমন: My Furniture">
        
        <label>মডেল ফাইল (.glb):</label>
        <input type="file" id="p-file" accept=".glb">

        <label>শ্যাডো ইনটেনসিটি (Shadow):</label>
        <select id="p-shadow">
            <option value="0">None</option>
            <option value="1" selected>Low</option>
            <option value="2">High</option>
        </select>

        <button class="btn" onclick="uploadAndSave()">Publish & Save to Cloud</button>
        <div id="status" style="margin-top: 10px; font-size: 12px;"></div>

        <div id="output-section">
            <p style="font-size: 13px; font-weight: bold;">স্থায়ী লিঙ্ক (এটি সেভ করে রাখুন):</p>
            <span id="ar-url" style="font-size: 11px; color: var(--blue); word-break: break-all;"></span>
            <button class="btn" style="background:#28a745" onclick="copyLink()">Copy Link</button>
        </div>
    </div>
</div>

<div id="viewer-container">
    <button class="back-btn" onclick="location.reload()">← Create New</button>
    <model-viewer id="main-viewer" 
        src="" 
        ar 
        ar-modes="webxr scene-viewer quick-look" 
        camera-controls 
        auto-rotate 
        shadow-intensity="1" 
        ar-placement="floor"
        style="width: 100%; height: 100%;">
    </model-viewer>
</div>

<script>
    const CLOUD_NAME = "dgn3gfiaf"; 
    const UPLOAD_PRESET = "my_ar_preset"; 

    async function uploadAndSave() {
        const file = document.getElementById('p-file').files[0];
        const title = document.getElementById('p-title').value;
        const shadow = document.getElementById('p-shadow').value;
        const status = document.getElementById('status');

        if(!file || !title) return alert("Please fill all fields!");

        status.innerHTML = "⏳ ক্লাউড সার্ভারে সেভ হচ্ছে...";
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', UPLOAD_PRESET);

        try {
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, {
                method: 'POST', body: formData
            });
            const data = await res.json();
            
            if(data.secure_url) {
                // সব সেটিংস ইউআরএল লিঙ্কে সেভ করে রাখা হচ্ছে
                const finalLink = window.location.origin + window.location.pathname + 
                                  "?model=" + encodeURIComponent(data.secure_url) + 
                                  "&sh=" + shadow + 
                                  "&name=" + encodeURIComponent(title);
                
                status.innerHTML = "<b style='color:#28a745'>✅ সেভ করা হয়েছে!</b>";
                document.getElementById('output-section').style.display = "block";
                document.getElementById('ar-url').innerText = finalLink;
            }
        } catch(e) { status.innerText = "❌ সেভ করতে ব্যর্থ হয়েছে।"; }
    }

    function copyLink() {
        navigator.clipboard.writeText(document.getElementById('ar-url').innerText);
        alert("Link Copied!");
    }

    // ক্লাউড থেকে সেভ করা ডাটা লোড করা
    const params = new URLSearchParams(window.location.search);
    const savedModel = params.get('model');
    const savedShadow = params.get('sh');

    if(savedModel) {
        document.getElementById('setup-ui').style.display = 'none';
        document.getElementById('viewer-container').style.display = 'block';
        
        const viewer = document.getElementById('main-viewer');
        viewer.src = savedModel;
        viewer.setAttribute('shadow-intensity', savedShadow || "1");
    }
</script>
</body>
    </html>
    
